#!/usr/bin/env sh
set -o errexit -o nounset -o xtrace

action="${1:?missing action}"

session_name=$(tmux display-message -p '#{session_name}')
window_id=$(tmux display-message -p '#{window_id}')
popup_name="${session_name}-${window_id}-popup"
is_popup="${TMUX_IS_POPUP:-}"

case "${action}" in
"kill")
    if [ "${is_popup}" ]; then
        tmux kill-session
    else
        tmux kill-window
    fi
    ;;
"toggle")
    if [ "${is_popup}" ]; then
        tmux detach-client
        exit
    fi

    if ! tmux has-session -t "${popup_name}"; then
        tmux new-session \
            -d \
            -e "TMUX_IS_POPUP=1" \
            -c '#{pane_current_path}' \
            -s "${popup_name}"
        tmux set-option -t "${popup_name}" status off
    fi
    tmux display-popup \
        -x C \
        -y C \
        -w 90% \
        -h 75% \
        -E "tmux attach-session -t '${popup_name}'"
    ;;
*)
    tmux display-message "invalid action: ${action}"
    exit 1
    ;;
esac
