#!/usr/bin/env sh
set -o errexit -o nounset -o xtrace

if ! which fzf >/dev/null 2>&1; then
    exit
fi

choice=$(
    {
        echo "ssh"
        echo ~
        find ~/repos -type d -maxdepth 20 2>/dev/null
    } | fzf
)
dir=
server=

case "${choice}" in
ssh)
    server=$(awk '/^Host/ { print $2 }' <"${HOME}/.ssh/config" | fzf)
    dir=$(
        ssh "${server}" -- echo "\${HOME}" "&&" find "\${HOME}/repos" -type d -maxdepth 20 |
            fzf
    )
    tmux send-keys "ssh '${server}'" Enter
    ;;
*)
    dir="${choice}"
    server=$(hostname)
    ;;
esac

tmux rename-window "${server}//$(basename "${dir}")"
tmux send-keys "cd '${dir}'" Enter
